# planetary-chaos.agent
name: Планетарный Хаос 2D
version: 0.6.0
description: |
  Многопользовательская браузерная игра «каждый игрок — планета».
  Полностью на Canvas 2D + Socket.io. Без Three.js и тяжёлых фреймворков.

  Основные идентификаторы — никнеймы (не socket.id).
  Планета сохраняется между перезагрузками вкладки, если ник не был самоуничтожен.
  При поражении в бою — планета полностью уничтожается, игрок видит экран смерти
  с информацией о бое и может заново создать планету (с тем же или новым ником).

# ── Технологический стек ─────────────────────────────────────
tech-stack:
  frontend:
    - HTML5 + Canvas 2D (все визуальные элементы рисуются вручную)
    - Второй canvas для bloom-эффекта (filter: blur + mix-blend-mode: screen)
    - Vanilla JavaScript (ES2023+)
    - Socket.io-client ^4.7.5
    - localStorage (хранение никнейма клиента)

  backend:
    - Node.js 20+
    - Express
    - Socket.io ^4.7.5
    - Хранение данных: пока in-memory (объект players по ключу nick)
    - Планируется: Redis / MongoDB / lowdb для персистентности

  сеть:
    - Сервер слушает на 0.0.0.0 (доступен по LAN)

  запуск:
    - Один файл index.html (открывается в браузере)
    - Один файл server.js

# ── Структура проекта ────────────────────────────────────────
files:
  - server.js          # основной сервер, игровая логика, сокеты, миссии, астероиды
  - index.html         # весь клиент (canvas + bloom + UI + ввод ника + мини-карта)
  - .agent             # этот файл — контекст для разработчиков / AI
  - package.json       # зависимости

# ── Как запускать ────────────────────────────────────────────
run:
  install: npm install
  start: node server.js
  client: открыть http://localhost:3000 в браузере
  dev: открыть несколько вкладок → проверить мультиплеер

# ── Зависимости ──────────────────────────────────────────────
dependencies:
  express: ^4.19.2
  socket.io: ^4.7.5

# ── Основные механики (актуальное состояние v0.6) ─────────────
mechanics:
  идентификация:
    - Никнейм (3–16 символов) вводится один раз
    - Сохраняется в localStorage
    - При перезагрузке вкладки — восстанавливается планета того же ника
    - При смерти в бою: планета полностью удаляется, игрок получает экран поражения
    - На экране поражения: кто убил, потерянные ресурсы, уровень, флот
    - Игрок вводит ник заново (может тот же или новый) и создаёт новую планету
    - Самоуничтожение: удаляет запись игрока → ник освобождается

  планета:
    - x, y (случайные при создании)
    - lvl (экономический уровень, влияет на доход)
    - res (ресурсы)
    - fleet (флот для атак и шахтёров)
    - defense (щит, покупается и регенерирует)
    - militaryLvl (бонус к атаке и скорости флота)
    - fortLvl (макс defense + авторегенерация)
    - lastAttack (timestamp для кулдауна)
    - last_seen (timestamp для определения оффлайн-игроков)

  экономика:
    - + (lvl × 8) res каждую секунду
    - Три ветки улучшений (Economy, Military, Fortification)
    - Покупка fleet (10 res за ед.) и defense (15 res за ед.)
    - Астероидное поле: 12 астероидов (50–200 res), респавн 60 сек
    - Добыча астероидов: отправка 1 fleet как шахтёра (летит, добывает, возвращается)

  дерево_улучшений:
    - Economy (lvl): увеличивает доход res/сек. Цена: 100 × 1.6^(lvl-1)
    - Military: +5% бонус к атаке и +10% скорости флота за уровень. Цена: 120 × 1.7^lvl
    - Fortification: +10 макс defense и +0.5 авторегенерация за уровень. Цена: 100 × 1.5^lvl

  PvP:
    - Кнопка «Режим атаки» → клик по чужой планете → диалог выбора кол-ва флота
    - Флот летит к цели (120 px/сек, military бустит скорость)
    - Все видят летящие флоты на карте
    - Цель видит предупреждение о входящей атаке (красная рамка)
    - Условие победы: fleet × milBonus > (fleet_цели + defense) × 0.6
    - Кулдаун атаки: 30 секунд
    - Победитель: крадёт 50% res, 70% посланного флота возвращается, планета цели уничтожается
    - Проигравший: весь посланный fleet теряется, defense цели -30%
    - При уничтожении: цель получает событие defeated с данными о бое → экран смерти

  миссии:
    - Серверная сущность missions[] — массив летящих объектов
    - Типы: attack (боевой флот), mine (шахтёр к астероиду), return (возврат с грузом)
    - Тик 50мс обновляет позиции, проверяет прибытие

  визуал (Canvas 2D):
    - Два canvas: основной + bloom (filter: blur(16px), mix-blend-mode: screen)
    - Параллакс-звёзды (3 слоя с разной скоростью)
    - Туманности / небулы (радиальные градиенты)
    - Анимированные кометы с хвостами
    - Пульсация планет
    - Радиальный градиент + тень → псевдо-3D планета
    - Атмосфера (градиентный ореол)
    - Щит (пунктирный круг, видимость зависит от defense)
    - Кольца (lvl > 4)
    - Вращающиеся луны (по количеству lvl)
    - Орбитальный флот (точки/квадратики)
    - Летящие флоты с trail-эффектами (огненный хвост)
    - Шахтёры с жёлтым/зелёным trail
    - Частицы при взрывах (с bloom)
    - Мини-карта (200×150) с планетами, астероидами, миссиями и рамкой обзора
    - Клик по мини-карте — перемещение камеры

  UI/UX:
    - Три экрана-оверлея: логин, экран смерти, игра
    - HUD с unicode-иконками (★ ◆ ✈ ○ ⚔ ☂) и всплывающими подсказками
    - Панель улучшений с названиями на русском, описаниями и ценой
    - Панель «Как играть» для новичков (можно скрыть, запоминает в localStorage)
    - Кнопка «Режим атаки» в панели действий
    - Экран смерти: кто убил, потерянные ресурсы/уровень/флот, поле ника для респавна

  навигация:
    - Space — центрировать камеру на своей планете
    - ПКМ + перетаскивание — перемещение камеры
    - Автоцентрирование при входе в игру
    - Escape — отмена режима атаки / закрытие диалога

# ── Правила разработки (обязательно для всех) ────────────────
rules:
  - Всё клиентское — в одном файле index.html (без сборщиков)
  - Никакого WebGL / Three.js / React / Vue
  - Основной ключ игрока — nick (строка)
  - socket.id используется только временно (для текущего соединения)
  - При disconnect → не удалять игрока сразу (только обновлять last_seen)
  - Самоуничтожение → полное удаление записи по нику
  - Комментарии в коде — преимущественно на русском
  - Новые механики сначала описывать здесь в .agent, потом реализовывать

# ── Ближайшие улучшения (приоритет 2026) ─────────────────────
todo-high:
  - Персистентность: подключить lowdb / better-sqlite3 / Redis
  - Защита от ник-сквоттинга (timeout оффлайн > 30 мин → можно перехватить)
  - Альянсы (суммирование флота при атаке)
  - Торговля ресурсами между игроками
  - Лидерборд (топ-10 по lvl / res / побед)

todo-medium:
  - Глобальный чат (ввод сообщений)
  - Названия планет (отдельное поле)
  - Звуковые эффекты (Web Audio API или Howler)
  - Zoom камеры (колёсико мыши)

# ── Конец конфига ────────────────────────────────────────────
